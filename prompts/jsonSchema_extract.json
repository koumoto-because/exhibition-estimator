{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/exhibition-takeoff.json",
  "title": "展示会図面・抽出結果と積算指示（カテゴリ分類版）",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "stage",
    "extractedAt",
    "nlCorrectionGlobal",
    "woodworkItems",
    "floorItems",
    "finishingItems",
    "electricalItems",
    "leaseItems",
    "siteCosts",
    "signItems"
  ],
  "properties": {
    "version": { "type": "string", "default": "1.1.13" },
    "stage": { "type": "string", "enum": ["extraction", "review", "ready_for_estimation"] },
    "extractedAt": { "type": "string", "format": "date-time" },

    "sourceDocument": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "filename": { "type": "string" },
        "page": { "type": "integer", "minimum": 1 },
        "dpi": { "type": "number", "minimum": 1 },
        "notes": { "type": "string" }
      }
    },

    "nlCorrectionGlobal": {
      "type": "string",
      "description": "抽出全体に対する自然言語の修正指示"
    },

    "nlCorrectionWoodworkItems": {
      "type": "string",
      "description": "木工造作物カテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCorrectionFloorItems": {
      "type": "string",
      "description": "床カテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCorrectionFinishingItems": {
      "type": "string",
      "description": "表装カテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCorrectionElectricalItems": {
      "type": "string",
      "description": "電気カテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCorrectionLeaseItems": {
      "type": "string",
      "description": "リースカテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCorrectionSiteCosts": {
      "type": "string",
      "description": "現場費（siteCosts）全体に対する自然言語の修正指示"
    },

    "nlCorrectionSignItems": {
      "type": "string",
      "description": "サイン（signItems）カテゴリ全体に対する自然言語の修正指示（項目ごとの nlCorrection とは別）"
    },
    "nlCollectionSignItems": {
      "type": "string",
      "description": "サイン（signItems）カテゴリ全体に対する自然言語の収集/補足（nlCorrectionとは別用途）"
    },

    "woodworkItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/woodworkItem" }
    },
    "floorItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/quantifiedCostItem" }
    },
    "finishingItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/quantifiedCostItem" }
    },
    "electricalItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/quantifiedElectricalItem" }
    },
    "leaseItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/leaseItem" }
    },

    "signItems": {
      "type": "array",
      "items": { "$ref": "#/$defs/signItem" }
    },

    "siteCosts": { "$ref": "#/$defs/siteCosts" }
  },

  "$defs": {
    "sourceKind": { "type": "string", "enum": ["chatGPT", "user"] },

    "costAmountWithNotes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["amount", "currency"],
      "properties": {
        "amount": { "type": "number", "minimum": 0 },
        "currency": { "type": "string", "default": "JPY" },
        "notes": { "type": "string" }
      }
    },

    "priceInstruction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "type": "string", "enum": ["estimate_by_model", "override_fixed"] },
        "currency": { "type": "string", "default": "JPY" },
        "unitPrice": { "type": ["number", "null"], "minimum": 0 },
        "notes": { "type": "string" }
      },
      "allOf": [
        {
          "if": { "properties": { "mode": { "const": "override_fixed" } } },
          "then": { "required": ["unitPrice"] }
        }
      ]
    },

    "baseItemFields": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "includeInEstimate", "price", "nlCorrection", "source"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "includeInEstimate": { "type": "boolean" },
        "price": { "$ref": "#/$defs/priceInstruction" },
        "nlCorrection": {
          "type": "string",
          "description": "この項目（アイテム）に対する自然言語の修正指示"
        },
        "source": { "$ref": "#/$defs/sourceKind" },
        "notes": { "type": "string" }
      }
    },

    "quantityUnit": {
      "type": "string",
      "enum": ["個", "台", "式", "m", "m²", "m³", "本", "枚", "人時", "人日"]
    },

    "quantifiedCostItem": {
      "allOf": [
        { "$ref": "#/$defs/baseItemFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["quantity", "unit", "cost"],
          "properties": {
            "quantity": { "type": "number", "exclusiveMinimum": 0 },
            "unit": { "$ref": "#/$defs/quantityUnit" },
            "cost": { "$ref": "#/$defs/costAmountWithNotes" }
          }
        }
      ]
    },

    "electricalType": {
      "type": "string",
      "enum": ["lighting", "panelboard", "outlet", "wiring", "switch", "labor", "other"]
    },

    "electricalSpec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "voltageV": { "type": ["number", "null"], "minimum": 0 },
        "wattW": { "type": ["number", "null"], "minimum": 0 },
        "phase": { "type": ["string", "null"], "enum": ["single", "three", null] },
        "breakerA": { "type": ["number", "null"], "minimum": 0 },
        "notes": { "type": "string" }
      }
    },

    "quantifiedElectricalItem": {
      "allOf": [
        { "$ref": "#/$defs/quantifiedCostItem" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["electricalType", "isHighPlace"],
          "properties": {
            "electricalType": { "$ref": "#/$defs/electricalType" },
            "isHighPlace": { "type": "boolean" },
            "spec": { "type": ["object", "null"], "allOf": [{ "$ref": "#/$defs/electricalSpec" }] }
          },
          "allOf": [
            {
              "if": { "properties": { "electricalType": { "enum": ["lighting", "panelboard"] } } },
              "then": { "required": ["spec"] }
            }
          ]
        }
      ]
    },

    "structureType": {
      "type": "string",
      "enum": [
        "既存壁パネル",
        "新規壁パネル",
        "特殊壁面",
        "単純什器",
        "特殊什器",
        "柱",
        "梁",
        "特大造作物",
        "複雑造作物",
        "サイン"
      ]
    },

    "dimensionHWD": {
      "type": "object",
      "additionalProperties": false,
      "required": ["height", "width", "depth"],
      "properties": {
        "height": { "type": "number", "exclusiveMinimum": 0 },
        "width": { "type": "number", "exclusiveMinimum": 0 },
        "depth": { "type": "number", "exclusiveMinimum": 0 },
        "unit": { "type": "string", "enum": ["mm", "cm", "m"], "default": "mm" }
      }
    },

    "materialKind": {
      "type": "string",
      "enum": ["小割", "垂木", "ベニヤ", "曲げベニヤ", "ポリ板", "メラミン", "ラワンランバ"]
    },

    "finishKind": {
      "type": "string",
      "enum": ["メラミン", "ポリ板", "経師", "出力シート", "塗装"]
    },

    "materialSpec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "quantity", "unit"],
      "properties": {
        "kind": { "$ref": "#/$defs/materialKind" },
        "spec": { "type": "string" },
        "quantity": { "type": "number", "exclusiveMinimum": 0 },
        "unit": { "type": "string", "enum": ["枚", "本", "m", "m²", "m³", "式", "個"] }
      }
    },

    "surfaceAreaWithNotes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value"],
      "properties": {
        "value": { "type": "number", "exclusiveMinimum": 0 },
        "unit": {
          "type": "string",
          "enum": ["m²", "枚", "ロール", "m"],
          "default": "m²"
        },
        "notes": { "type": "string" }
      }
    },

    "finishEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind"],
      "properties": {
        "kind": { "$ref": "#/$defs/finishKind" },
        "spec": {
          "type": "string",
          "description": "仕上げの仕様（例：色番、品番、シート種別など）"
        },
        "surfaceArea": { "$ref": "#/$defs/surfaceAreaWithNotes" },
        "notes": { "type": "string" }
      }
    },

    "coefficientWithNotes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value"],
      "properties": {
        "value": { "type": "number", "exclusiveMinimum": 0 },
        "notes": { "type": "string" }
      }
    },

    "laborSpec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["amount", "unit"],
      "properties": {
        "amount": { "type": "number", "exclusiveMinimum": 0 },
        "unit": { "type": "string", "enum": ["人日", "人時"] },
        "notes": { "type": "string" }
      }
    },

    "woodworkItem": {
      "allOf": [
        { "$ref": "#/$defs/baseItemFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "quantity",
            "structureType",
            "dimensions",
            "materials",
            "finishes",
            "finishSurfaceArea",
            "isBent",
            "hasSpecialAngles",
            "supportsHeavyLoad",
            "outlineDescription",
            "laborPerUnit",
            "laborTotal",
            "laborCoefficient",
            "boundingBoxVolume",
            "materialCost",
            "laborCost"
          ],
          "properties": {
            "quantity": { "type": "integer", "minimum": 1 },
            "structureType": { "$ref": "#/$defs/structureType" },
            "dimensions": { "$ref": "#/$defs/dimensionHWD" },
            "materials": { "type": "array", "items": { "$ref": "#/$defs/materialSpec" } },
            "finishes": { "type": "array", "items": { "$ref": "#/$defs/finishEntry" } },
            "finishSurfaceArea": { "$ref": "#/$defs/surfaceAreaWithNotes" },
            "isBent": { "type": "boolean" },
            "hasSpecialAngles": { "type": "boolean" },
            "supportsHeavyLoad": { "type": "boolean" },
            "outlineDescription": { "type": "string" },
            "laborPerUnit": { "$ref": "#/$defs/laborSpec" },
            "laborTotal": { "$ref": "#/$defs/laborSpec" },
            "laborCoefficient": { "$ref": "#/$defs/coefficientWithNotes" },
            "boundingBoxVolume": { "type": "number", "minimum": 0 },
            "materialCost": { "$ref": "#/$defs/costAmountWithNotes" },
            "laborCost": { "$ref": "#/$defs/costAmountWithNotes" },
            "recognitionConfidence": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        }
      ]
    },

    "leaseItem": {
      "allOf": [
        { "$ref": "#/$defs/baseItemFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["quantity", "unit", "cost"],
          "properties": {
            "quantity": { "type": "number", "exclusiveMinimum": 0 },
            "unit": { "$ref": "#/$defs/quantityUnit" },
            "cost": { "$ref": "#/$defs/costAmountWithNotes" }
          }
        }
      ]
    },

    "signType": {
      "type": "string",
      "enum": ["カッティングシート", "抜き行灯", "チャネルサイン", "バルーン", "その他"]
    },

    "signItem": {
      "allOf": [
        { "$ref": "#/$defs/quantifiedCostItem" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["signType"],
          "properties": {
            "signType": { "$ref": "#/$defs/signType" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["price"],
          "properties": {
            "price": {
              "allOf": [
                { "$ref": "#/$defs/priceInstruction" },
                {
                  "type": "object",
                  "required": ["unitPrice"],
                  "properties": {
                    "mode": { "const": "override_fixed" }
                  }
                }
              ]
            }
          }
        }
      ]
    },

    "siteCosts": {
      "type": "object",
      "additionalProperties": false,
      "required": ["laborCost", "transportCost", "wasteDisposalCost"],
      "properties": {
        "laborCost": { "$ref": "#/$defs/siteLaborCost" },
        "transportCost": { "$ref": "#/$defs/siteTransportCost" },
        "wasteDisposalCost": { "$ref": "#/$defs/siteWasteDisposalCost" },
        "notes": { "type": "string" }
      }
    },

    "siteLaborEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label", "people", "days"],
      "properties": {
        "label": { "type": "string", "minLength": 1 },
        "people": { "type": "integer", "minimum": 0 },
        "days": { "type": "number", "minimum": 0 },
        "notes": { "type": "string" }
      }
    },

    "siteLaborCost": {
      "type": "object",
      "additionalProperties": false,
      "required": ["unitPrice", "entries"],
      "properties": {
        "unitPrice": { "type": "number", "minimum": 0 },
        "entries": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/siteLaborEntry" }
        },
        "cost": { "$ref": "#/$defs/costAmountWithNotes" },
        "notes": { "type": "string" }
      }
    },

    "siteTransportEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label", "vehicleType", "vehicles", "days", "unitPrice"],
      "properties": {
        "label": { "type": "string", "minLength": 1 },
        "vehicleType": { "type": "string" },
        "vehicles": { "type": "integer", "minimum": 0 },
        "days": { "type": "number", "minimum": 0 },
        "unitPrice": { "type": "number", "minimum": 0 },
        "cost": { "$ref": "#/$defs/costAmountWithNotes" },
        "notes": { "type": "string" }
      }
    },

    "siteTransportCost": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entries"],
      "properties": {
        "entries": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/siteTransportEntry" }
        },
        "cost": { "$ref": "#/$defs/costAmountWithNotes" },
        "notes": { "type": "string" }
      }
    },

    "siteWasteDisposalCost": {
      "type": "object",
      "additionalProperties": false,
      "required": ["vehicles", "unitPrice"],
      "properties": {
        "vehicles": { "type": "integer", "minimum": 0 },
        "unitPrice": { "type": "number", "minimum": 0 },
        "cost": { "$ref": "#/$defs/costAmountWithNotes" },
        "notes": { "type": "string" }
      }
    }
  }
}
