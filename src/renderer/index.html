<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>展示会木工積算アシスタント</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 10px 16px;
        border-bottom: 1px solid #ddd;
        font-weight: 600;
        background: #f5f5f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      main {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .column {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .column-left {
        flex: 0 0 380px;
        max-width: 420px;
        border-right: 1px solid #ddd;
      }

      .column-right {
        flex: 1 1 auto;
      }

      .section {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        flex-shrink: 0;
      }

      .section h2 {
        margin: 0 0 4px;
        font-size: 14px;
      }

      textarea {
        width: 100%;
        resize: none;
        font-family: Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        box-sizing: border-box;
      }

      label {
        font-size: 12px;
      }

      select,
      button,
      input[type="number"],
      input[type="text"] {
        font-size: 12px;
      }

      #status {
        font-size: 11px;
        color: #555;
      }

      #left-scroll,
      #right-scroll {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: auto;
      }

      #prompt-area {
        padding: 8px 12px;
        flex: 1;
      }

      #prompt-text {
        height: 100%;
      }

      #json-input-area {
        padding: 8px 12px;
        border-top: 1px solid #eee;
        flex-shrink: 0;
      }

      #gpt-output {
        height: 120px;
        margin-top: 4px;
      }

      #right-scroll-inner {
        display: flex;
        flex-direction: column;
        flex: 1;
        padding: 8px 12px;
        box-sizing: border-box;
      }

      #items-view {
        flex: 0 0 auto;
        max-height: 260px;
        overflow: auto;
        font-size: 12px;
        margin-bottom: 8px;
      }

      #items-view thead th {
        position: sticky;
        top: 0;
        background: #f0f0f0;
        z-index: 1;
      }

      #item-editor-container {
        flex: 1 1 auto;
        border-top: 1px solid #ddd;
        padding-top: 8px;
        overflow: auto;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 2px 4px;
        text-align: left;
      }

      th {
        background: #f0f0f0;
      }

      tr[data-index] {
        cursor: pointer;
      }

      tr[data-index].selected {
        outline: 2px solid #ffb347;
      }

      .item-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 4px;
        align-items: center;
      }

      .item-form-row label {
        min-width: 120px;
      }

      .repeat-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
      }

      .repeat-row {
        display: flex;
        gap: 6px;
        align-items: center;
        width: 100%;
      }

      .repeat-row input,
      .repeat-row select {
        flex: 0 0 auto;
      }

      .repeat-row .repeat-kind {
        width: 140px;
      }

      .repeat-row .repeat-spec {
        width: 200px;
      }

      .repeat-row .repeat-qty {
        width: 90px;
      }

      .repeat-row .repeat-unit {
        width: 80px;
      }

      .sitecosts-block {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 8px;
      }

      .sitecosts-drawer summary {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-weight: 400;
        list-style: none;
      }

      .sitecosts-drawer summary::-webkit-details-marker {
        display: none;
      }

      .sitecosts-drawer summary::before {
        content: "▶";
        display: inline-block;
        font-size: 12px;
        margin-right: 2px;
      }

      .sitecosts-drawer[open] summary::before {
        content: "▼";
      }

      .sitecosts-summary-inner {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .sitecosts-cost-inline {
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
      }

      .sitecosts-pair {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .sitecosts-row label {
        min-width: auto;
      }

      .sitecosts-labor-grid {
        display: grid;
        grid-template-columns: minmax(120px, 1.4fr) minmax(60px, 0.8fr) minmax(60px, 0.8fr) 56px;
        gap: 8px;
        align-items: center;
      }

      .sitecosts-labor-grid.header {
        font-size: 11px;
        color: #555;
        font-weight: 600;
      }

      .sitecosts-labor-grid input {
        width: 100%;
      }

      .sitecosts-transport-grid {
        display: grid;
        grid-template-columns:
          minmax(120px, 1.2fr)
          minmax(100px, 1.4fr)
          minmax(60px, 0.7fr)
          minmax(60px, 0.7fr)
          minmax(80px, 1fr)
          56px;
        gap: 8px;
        align-items: center;
      }

      .sitecosts-transport-grid.header {
        font-size: 11px;
        color: #555;
        font-weight: 600;
      }

      .sitecosts-transport-grid input {
        width: 100%;
      }

      .sitecosts-drawer {
        background: transparent;
        border: none;
        padding: 0;
        margin: 6px 0;
      }

      .sitecosts-drawer-body {
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 0;
        padding: 6px;
        margin-top: 4px;
      }

      .sitecosts-drawer input[type="text"],
      .sitecosts-drawer input[type="number"] {
        flex: 0 1 auto;
      }

      .estimate-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .estimate-table th,
      .estimate-table td {
        border-bottom: 1px solid #eee;
        padding: 4px 6px;
        text-align: left;
      }

      .estimate-table tbody tr.selected {
        background: #f0f6ff;
      }

      .estimate-lines-row,
      .estimate-lines-header {
        display: grid;
        grid-template-columns: minmax(140px, 1.6fr) minmax(70px, 0.7fr) minmax(60px, 0.6fr) minmax(80px, 0.8fr) minmax(80px, 0.8fr) minmax(120px, 1fr) 56px;
        gap: 6px;
        align-items: center;
      }

      .estimate-lines-header {
        font-size: 11px;
        color: #555;
        font-weight: 600;
      }

      .estimate-lines-row input {
        width: 100%;
      }

      .item-form-spec {
        gap: 8px;
      }

      .item-form-spec > label {
        min-width: 120px;
      }

      .spec-pair {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .spec-pair label {
        min-width: auto;
      }

      .spec-input {
        width: 10ch;
      }

      .spec-unit {
        font-size: 12px;
        color: #555;
      }

      body[data-category]:not([data-category="woodworkItems"]) [data-woodwork-only] {
        display: none !important;
      }

      body[data-category="woodworkItems"] [data-generic-only] {
        display: none !important;
      }

      body[data-category]:not([data-category="electricalItems"]) [data-electrical-only] {
        display: none !important;
      }

      body[data-category]:not([data-category="signItems"]) [data-sign-only] {
        display: none !important;
      }

      .nl-category {
        display: none;
      }

      body[data-category="woodworkItems"] .nl-woodwork,
      body[data-category="floorItems"] .nl-floor,
      body[data-category="finishingItems"] .nl-finishing,
      body[data-category="signItems"] .nl-sign,
      body[data-category="electricalItems"] .nl-electrical,
      body[data-category="leaseItems"] .nl-lease,
      body[data-category="siteCosts"] .nl-sitecosts {
        display: block;
      }

      body[data-category="siteCosts"] #item-form-fields {
        display: none;
      }

      body:not([data-category="siteCosts"]) #site-costs-section {
        display: none;
      }

      .item-form-row input[type="text"],
      .item-form-row input[type="number"],
      .item-form-row select,
      .item-form-row textarea {
        flex: 1;
      }

      .item-form-row .repeat-row input,
      .item-form-row .repeat-row select {
        flex: 0 0 auto;
      }

      .inline-note {
        font-size: 11px;
        color: #666;
      }

      .tabs {
        display: inline-flex;
        border-radius: 999px;
        border: 1px solid #ccc;
        overflow: hidden;
        margin-top: 4px;
      }

      .tab-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
      }

      .tab-btn {
        padding: 2px 10px;
        font-size: 11px;
        border: none;
        background: transparent;
        cursor: pointer;
      }

      .tab-btn.active {
        background: #007aff;
        color: #fff;
      }

      .tab-content {
        margin-top: 4px;
      }

      .hidden {
        display: none;
      }

      details summary {
        cursor: pointer;
        font-size: 12px;
      }

      details {
        margin-top: 4px;
        margin-bottom: 4px;
        padding: 4px 6px;
        background: #f8f8f8;
        border-radius: 4px;
      }

      /* 変更ハイライト */
      .user-changed-current {
        background-color: #a8ffb0 !important; /* 今ラウンドの手動変更（濃い緑） */
      }
      .user-changed-previous {
        background-color: #e0ffe0 !important; /* ひとつ前ラウンドの手動変更（薄い緑） */
      }
      .api-changed {
        background-color: #fff7c2 !important; /* API（ChatGPT）変更（黄） */
      }

      .header-right-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }

    </style>
  </head>
  <body>
    <header>
      <div>展示会木工造作 積算アシスタント（テストモード対応）</div>
      <div class="header-right-group">
        <label>
          <input type="checkbox" id="change-highlight-toggle" checked />
          変更ハイライト
        </label>
        <label>
          <input type="checkbox" id="test-mode-toggle" />
          テストモード
        </label>
        <span id="status"></span>
      </div>
    </header>

    <main>
      <!-- 左カラム：プロンプト＋JSON貼り付け -->
      <div class="column column-left">
        <div id="left-scroll">
          <div class="section">
            <h2>1. プロンプト生成（ChatGPTに手動で投げる用）</h2>
            <div>
              <label for="stage-select">ステージ:</label>
              <select id="stage-select">
                <option value="extract">1: 図面→構造物抽出</option>
                <option value="update">2: JSON差分反映</option>
                <option value="estimate">3: 最終積算</option>
              </select>
              <button id="btn-load-prompt">プロンプト読込</button>
            </div>
            <p style="font-size: 11px; margin-top: 4px;">
              ※テストモード時：ここに表示されたプロンプトをChatGPTに貼り付け、図面ファイルも添付して実行してください。
            </p>
          </div>

          <div id="prompt-area">
            <textarea id="prompt-text" spellcheck="false"></textarea>
          </div>

          <div id="json-input-area">
            <h2 style="font-size: 13px; margin: 0 0 4px;">
              2. ChatGPT出力(JSON)の貼り付け
            </h2>
            <p style="font-size: 11px; margin-top: 2px;">
              ChatGPTから返ってきたJSONを下に貼り付け、「JSONを取り込む」を押してください。
            </p>
            <textarea
              id="gpt-output"
              placeholder="ChatGPTから返ってきたJSONをここに貼り付けてください"
              spellcheck="false"
            ></textarea>

            <div style="margin-top: 4px; display: flex; gap: 4px; flex-wrap: wrap;">
              <button id="btn-import-json">JSONを取り込む</button>
              <button id="btn-restore-state" disabled>
                ロールバック(UNDO)
              </button>
              <button id="btn-redo-state" disabled>
                やり直し(REDO)
              </button>
            </div>

            <p style="font-size: 10px; color: #666; margin-top: 2px;">
              ※UNDO/REDO は、直近の状態から最大5ステップまで戻したり進めたりできます（色のマークも含めて復元）。
            </p>

            <details id="state-io-panel">
              <summary>状態のエクスポート／インポート（ファイル）</summary>
              <p style="font-size: 11px; margin-top: 4px;">
                現在の状態（JSON・選択中アイテム・色マーク情報など）を
                <strong>.json テキストファイル</strong>
                として保存・再読み込みできます。
              </p>

              <div style="margin-top: 4px; display: flex; gap: 4px; flex-wrap: wrap; align-items: center;">
                <button id="btn-export-state-file">状態をファイルに保存</button>
                <input
                  id="state-file-input"
                  type="file"
                  accept=".json,application/json,text/plain"
                  style="display: none;"
                />
                <button id="btn-import-state-file">ファイルから状態を読み込み</button>
              </div>

              <p style="font-size: 10px; color: #666; margin-top: 2px;">
                ※保存したファイルを同じボタンから読み込むことで、別のマシンや後日でも同じ状態に復元できます。
              </p>
            </details>
          </div>
        </div>
      </div>

      <!-- 右カラム：構造物一覧＋編集 -->
      <div class="column column-right">
        <div id="right-scroll">
          <div id="right-scroll-inner">
            <div class="tab-bar" style="margin-bottom: 6px;">
              <div class="tabs">
                <button id="page-tab-extract" class="tab-btn active" type="button">構造物編集</button>
                <button id="page-tab-estimate" class="tab-btn" type="button">見積書作成</button>
              </div>
            </div>

            <div id="extract-page">
            <div class="section" style="border-bottom: none; padding-bottom: 4px;">
              <h2>3. 構造物リストと編集</h2>
              <p style="font-size: 11px; margin-top: 2px;">
                テーブル行をクリック → 右下フォームを編集すると即座に反映されます。<br />
                濃い緑＝現在ラウンドでの手動編集 / 薄い緑＝前ラウンドの手動編集 / 黄＝ChatGPT側での変更
              </p>
              <div class="tab-bar" style="margin-top: 6px;">
                <div id="category-tabs" class="tabs"></div>
                <button id="btn-generate-diff" type="button">
                  差分JSONを生成して「更新プロンプト」にセット
                </button>
              </div>
            </div>

            <!-- nlCorrection per category -->
            <div class="section" style="border-top: 1px solid #eee;">
              <h2>カテゴリ修正指示</h2>
              <p style="font-size: 11px; margin: 2px 0 4px;">
                各カテゴリ全体に対する自然言語の修正指示です。入力すると即時にJSONへ反映されます。
              </p>
              <textarea
                id="nl-woodwork"
                class="nl-category nl-woodwork"
                placeholder="木工造作物の修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-floor"
                class="nl-category nl-floor"
                placeholder="床の修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-finishing"
                class="nl-category nl-finishing"
                placeholder="表装の修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-sign"
                class="nl-category nl-sign"
                placeholder="サインの修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-electrical"
                class="nl-category nl-electrical"
                placeholder="電気の修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-lease"
                class="nl-category nl-lease"
                placeholder="リースの修正指示"
                spellcheck="false"
              ></textarea>
              <textarea
                id="nl-sitecosts"
                class="nl-category nl-sitecosts"
                placeholder="現場費（siteCosts）の修正指示"
                spellcheck="false"
              ></textarea>

            </div>

            <div id="items-view"></div>
            <div id="items-controls" style="margin-top: 6px; display:flex; gap:6px; align-items:center;">
              <button id="btn-item-add" type="button">+</button>
              <button id="btn-item-remove" type="button">-</button>
              <span class="inline-note">※追加後は下の「フォーム編集」で入力してください（source="user" / id自動採番）</span>
            </div>

            <div id="item-editor-container">
              <div style="margin-bottom: 4px; font-size: 12px;">
                <strong>選択中アイテム</strong>
                <span
                  id="item-editor-label"
                  style="margin-left: 8px; font-size: 11px; color: #555;"
                >
                  （行をクリックするとここに表示されます）
                </span>
              </div>

              <!-- タブ切り替え：フォーム / JSON -->
              <div class="tab-bar">
                <div class="tabs">
                  <button id="tab-form" class="tab-btn active" type="button">
                    フォーム編集
                  </button>
                  <button id="tab-json" class="tab-btn" type="button">
                    JSON編集
                  </button>
                </div>
              </div>

              <!-- フォームタブ -->
              <div class="tab-content" id="tab-content-form">
                <div id="item-form-fields">
                <div class="item-form-row">
                  <label>ID</label>
                  <span id="item-form-id" style="font-size: 11px; color: #555;">-</span>
                </div>

                <div class="item-form-row">
                  <label for="item-form-include">
                    積算対象(includeInEstimate)
                  </label>
                  <input id="item-form-include" type="checkbox" />
                  <span class="inline-note">チェックで積算対象に含める</span>
                </div>

                <div class="item-form-row">
                  <label for="item-form-name">名称(name)</label>
                  <input id="item-form-name" type="text" />
                </div>

                <div class="item-form-row" data-sign-only>
                  <label for="item-form-sign-type">種別</label>
                  <select id="item-form-sign-type">
                    <option value="">（未設定）</option>
                    <option value="カッティングシート">カッティングシート</option>
                    <option value="抜き行灯">抜き行灯</option>
                    <option value="チャネルサイン">チャネルサイン</option>
                    <option value="バルーン">バルーン</option>
                    <option value="その他">その他</option>
                  </select>
                </div>

                <div class="item-form-row" data-electrical-only>
                  <label for="item-form-electrical-type">種別</label>
                  <select id="item-form-electrical-type">
                    <option value="">（未設定）</option>
                    <option value="lighting">照明</option>
                    <option value="panelboard">分電盤</option>
                    <option value="outlet">コンセント</option>
                    <option value="wiring">配線</option>
                    <option value="switch">スイッチ</option>
                    <option value="labor">人工</option>
                    <option value="other">その他</option>
                  </select>
                </div>

                <div class="item-form-row item-form-spec" data-electrical-only>
                  <label>仕様</label>
                  <span class="spec-pair">
                    <label>電圧</label>
                    <input id="item-form-spec-voltage" class="spec-input" type="number" step="1" placeholder="V" />
                    <span class="spec-unit">V</span>
                  </span>
                  <span class="spec-pair">
                    <label>電力</label>
                    <input id="item-form-spec-watt" class="spec-input" type="number" step="1" placeholder="W" />
                    <span class="spec-unit">W</span>
                  </span>
                  <span class="spec-pair">
                    <label>位相</label>
                    <select id="item-form-spec-phase" class="spec-input">
                      <option value="">未設定</option>
                      <option value="single">単相</option>
                      <option value="three">三相</option>
                    </select>
                  </span>
                  <span class="spec-pair">
                    <label>定格電流</label>
                    <input id="item-form-spec-breaker" class="spec-input" type="number" step="1" placeholder="A" />
                    <span class="spec-unit">A</span>
                  </span>
                </div>

                <div class="item-form-row" data-electrical-only>
                  <label>仕様メモ</label>
                  <input id="item-form-spec-notes" type="text" placeholder="spec.notes" />
                </div>

                <div class="item-form-row">
                  <label for="item-form-quantity">数量(quantity)</label>
                  <input id="item-form-quantity" type="number" step="1" min="1" placeholder="数量" style="max-width: 100px;" />
                  <select id="item-form-unit" data-generic-only style="max-width: 120px;">
                    <option value="">（未設定）</option>
                    <option value="個">個</option>
                    <option value="台">台</option>
                    <option value="式">式</option>
                    <option value="m">m</option>
                    <option value="m²">m²</option>
                    <option value="m³">m³</option>
                    <option value="本">本</option>
                    <option value="枚">枚</option>
                    <option value="人時">人時</option>
                    <option value="人日">人日</option>
                  </select>
                </div>

                <div class="item-form-row">
                  <label for="item-form-price-unitprice">単価(price.unitPrice)</label>
                  <input id="item-form-price-unitprice" type="number" step="1" placeholder="数値のみ, JPY" />
                </div>

                <div class="item-form-row" data-generic-only>
                  <label>費用(cost.amount/notes)</label>
                  <input id="item-form-cost-amount" type="number" step="1" placeholder="金額(JPY)" style="max-width: 140px;" />
                  <input id="item-form-cost-notes" type="text" placeholder="根拠メモ(任意)" />
                </div>

                <div class="item-form-row" data-electrical-only>
                  <label for="item-form-is-high-place">高所作業(isHighPlace)</label>
                  <input id="item-form-is-high-place" type="checkbox" />
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label for="item-form-structure-type">
                    種別(structureType)
                  </label>
                  <select id="item-form-structure-type">
                    <option value="">（変更しない）</option>
                    <option value="既存壁パネル">既存壁パネル</option>
                    <option value="新規壁パネル">新規壁パネル</option>
                    <option value="特殊壁面">特殊壁面</option>
                    <option value="単純什器">単純什器</option>
                    <option value="特殊什器">特殊什器</option>
                    <option value="柱">柱</option>
                    <option value="梁">梁</option>
                    <option value="特大造作物">特大造作物</option>
                    <option value="複雑造作物">複雑造作物</option>
                  </select>
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label>寸法(dimensions H/W/D, mm)</label>
                  <input id="item-form-dim-h" type="number" step="1" placeholder="H" style="width: 60px;" />
                  <input id="item-form-dim-w" type="number" step="1" placeholder="W" style="width: 60px;" />
                  <input id="item-form-dim-d" type="number" step="1" placeholder="D" style="width: 60px;" />
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label>材料</label>
                </div>
                <div class="item-form-row" data-woodwork-only>
                  <div id="item-form-materials-list" class="repeat-list"></div>
                </div>
                <div class="item-form-row" data-woodwork-only>
                  <button id="item-form-materials-add" type="button">+ 材料を追加</button>
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label>仕上げ</label>
                </div>
                <div class="item-form-row" data-woodwork-only>
                  <div id="item-form-finishes-list" class="repeat-list"></div>
                </div>
                <div class="item-form-row" data-woodwork-only>
                  <button id="item-form-finishes-add" type="button">+ 仕上げを追加</button>
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label>材料費(materialCost.amount/notes)</label>
                  <input id="item-form-materialcost-amount" type="number" step="1" placeholder="金額(JPY)" style="max-width: 140px;" />
                  <input id="item-form-materialcost-notes" type="text" placeholder="根拠メモ(任意)" />
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label for="item-form-labor-perunit-days">人工(1台あたり laborPerUnit, 人日)</label>
                  <input id="item-form-labor-perunit-days" type="number" step="0.01" placeholder="人日" style="max-width: 100px;" />
                  <span class="inline-note">※内部的には laborPerUnit.unit="人日"</span>
                </div>

                <div class="item-form-row" data-woodwork-only>
                  <label for="item-form-labor-days">人工合計(laborTotal, 人日)</label>
                  <input id="item-form-labor-days" type="number" step="0.01" placeholder="人日" style="max-width: 100px;" />
                  <span class="inline-note">※内部的には laborTotal.unit="人日"</span>
                </div>

                <details id="item-advanced" data-woodwork-only>
                  <summary>詳細設定</summary>

                  <div class="item-form-row">
                    <label for="item-form-isbent">曲げ(isBent)</label>
                    <input id="item-form-isbent" type="checkbox" />
                  </div>

                  <div class="item-form-row">
                    <label for="item-form-special-angles">特殊角(hasSpecialAngles)</label>
                    <input id="item-form-special-angles" type="checkbox" />
                  </div>

                  <div class="item-form-row">
                    <label for="item-form-support-heavy">重量物支持(supportsHeavyLoad)</label>
                    <input id="item-form-support-heavy" type="checkbox" />
                  </div>

                  <div class="item-form-row">
                    <label>仕上げ表面積(finishSurfaceArea)</label>
                    <input id="item-form-finisharea-value" type="number" step="0.01" placeholder="m²" style="max-width: 100px;" />
                    <input id="item-form-finisharea-notes" type="text" placeholder="算出根拠(任意)" />
                  </div>

                  <div class="item-form-row">
                    <label>人工係数(laborCoefficient)</label>
                    <input id="item-form-laborcoef-value" type="number" step="0.01" placeholder="係数" style="max-width: 100px;" />
                    <input id="item-form-laborcoef-notes" type="text" placeholder="根拠メモ(任意)" />
                  </div>
                </details>

                <div class="item-form-row">
                  <label for="item-form-nlcorrection">自然言語修正指示(nlCorrection)</label>
                </div>
                <div class="item-form-row">
                  <textarea
                    id="item-form-nlcorrection"
                    rows="3"
                    style="width: 100%;"
                    placeholder="例: 壁面仕上げを経師からポリ板に変更、開口900×2100を追加 など"
                  ></textarea>
                </div>

                <div style="margin-top: 4px; margin-bottom: 6px; font-size: 11px; color: #666;">
                  ※フォームの値を変更すると、即座にアイテムとテーブル・JSON編集内容に反映されます。
                </div>
                </div>

                <div class="section" id="site-costs-section" style="border-top: 1px solid #eee;">
                  <h2>現場費（siteCosts）</h2>
                  <div id="sitecosts-form-labor">
                    <div class="item-form-row sitecosts-row">
                      <label>単価</label>
                      <input id="sitecosts-labor-unitprice" type="number" step="1" placeholder="単価(JPY)" style="max-width: 140px;" />
                    </div>
                    <div class="sitecosts-labor-grid header">
                      <span>ラベル</span>
                      <span>人数</span>
                      <span>日数</span>
                      <span></span>
                    </div>
                    <div id="sitecosts-labor-list"></div>
                    <div class="item-form-row sitecosts-row">
                      <button id="sitecosts-labor-add" type="button">人工の行を追加</button>
                    </div>
                  </div>
                  <div id="sitecosts-form-transport">
                    <div class="sitecosts-transport-grid header">
                      <span>ラベル</span>
                      <span>車種</span>
                      <span>台数</span>
                      <span>日数</span>
                      <span>単価</span>
                      <span></span>
                    </div>
                    <div id="sitecosts-transport-list"></div>
                    <div class="item-form-row sitecosts-row">
                      <button id="sitecosts-transport-add" type="button">運搬の行を追加</button>
                    </div>
                  </div>
                  <div id="sitecosts-form-waste">
                    <div class="item-form-row sitecosts-row">
                      <label>台数</label>
                      <input id="sitecosts-waste-vehicles" type="number" step="1" placeholder="台数" style="max-width: 120px;" />
                      <label>単価</label>
                      <input id="sitecosts-waste-unitprice" type="number" step="1" placeholder="単価(JPY)" style="max-width: 140px;" />
                    </div>
                  </div>
                </div>
              </div>

              <!-- JSON編集タブ -->
              <div class="tab-content hidden" id="tab-content-json">
                <div style="margin-top: 4px; font-size: 12px;">
                  <strong>JSON直接編集</strong>
                  <span class="inline-note">（複雑な構造はここで編集してください）</span>
                </div>
                <textarea
                  id="item-editor"
                  rows="10"
                  spellcheck="false"
                  placeholder="{ ... 選択したアイテムのJSON ... }"
                ></textarea>
                <div style="margin-top: 4px;">
                  <button id="btn-apply-item-edit">JSONの変更をアイテムに反映</button>
                </div>
              </div>
            </div>
          </div>
          </div>

          <div id="estimate-page" hidden>
            <div class="section">
              <h2>見積書作成</h2>
              <p style="font-size: 11px; margin-top: 2px;">
                抽出JSONを見積書用のJSONに成形するための画面です。必要な値を入力してください。
              </p>
              <div class="item-form-row">
                <button id="btn-estimate-generate" type="button">抽出JSONから下書き作成</button>
                <span class="inline-note">※現在読み込まれている構造物JSONを基に見積書の下書きを作成します。</span>
              </div>
            </div>

            <div class="section">
              <h3>基本情報</h3>
              <div class="item-form-row">
                <label for="estimate-title">製作名称</label>
                <input id="estimate-title" type="text" placeholder="例: 展示ブース造作一式" />
              </div>
              <div class="item-form-row">
                <label for="estimate-client">宛名</label>
                <input id="estimate-client" type="text" placeholder="例: 〇〇株式会社 御中" />
              </div>
              <div class="item-form-row">
                <label for="estimate-total-amount">合計金額</label>
                <input id="estimate-total-amount" type="number" step="1" placeholder="円" style="max-width: 160px;" readonly />
                <span class="inline-note">グループ内容から自動集計されます。</span>
              </div>
              <div class="item-form-row">
                <label>消費税</label>
                <label style="display: flex; align-items: center; gap: 6px;">
                  <input id="estimate-tax-included" type="checkbox" />
                  税込
                </label>
                <label style="display: flex; align-items: center; gap: 6px;">
                  税率
                  <input id="estimate-tax-rate" type="number" step="0.01" min="0" max="1" placeholder="0.10" style="max-width: 100px;" />
                </label>
              </div>
              <div class="item-form-row">
                <label for="estimate-breakdown-title">内訳表タイトル</label>
                <input id="estimate-breakdown-title" type="text" placeholder="例: 工事内訳明細表" />
              </div>
            </div>

            <div class="section">
              <h3>内訳グループ</h3>
              <div id="estimate-groups-view"></div>
              <div id="estimate-groups-controls" style="margin-top: 6px; display:flex; gap:6px; align-items:center;">
                <button id="btn-estimate-group-add" type="button">+</button>
                <button id="btn-estimate-group-remove" type="button">-</button>
              </div>

              <div id="estimate-group-editor" style="margin-top: 8px;">
                <div style="margin-bottom: 4px; font-size: 12px;">
                  <strong>選択中グループ</strong>
                  <span id="estimate-group-label" style="margin-left: 8px; font-size: 11px; color: #555;">
                    （行をクリックするとここに表示されます）
                  </span>
                </div>

                <div class="item-form-row">
                  <label for="estimate-group-no">№</label>
                  <input id="estimate-group-no" type="number" step="1" min="1" style="max-width: 80px;" />
                </div>
                <div class="item-form-row">
                  <label for="estimate-group-category">種別</label>
                  <input id="estimate-group-category" type="text" placeholder="例: 木工造作" />
                </div>
                <div class="item-form-row">
                  <label for="estimate-group-display">表示モード</label>
                  <select id="estimate-group-display">
                    <option value="summary">summary（概要）</option>
                    <option value="detailed">detailed（内訳）</option>
                  </select>
                </div>
                <div class="item-form-row">
                  <label for="estimate-group-notes">注記</label>
                  <textarea id="estimate-group-notes" rows="2" placeholder="1行につき1つ"></textarea>
                </div>

                <div class="section" id="estimate-group-pricing">
                  <h4>利益率設定</h4>
                  <div class="item-form-row">
                    <label for="estimate-group-margin">利益率</label>
                    <input id="estimate-group-margin" type="number" step="0.01" min="0" placeholder="0.30" style="max-width: 100px;" />
                    <span class="inline-note">原価に対する利益率</span>
                  </div>
                  <div class="item-form-row">
                    <label>帳票非表示</label>
                    <label style="display: flex; align-items: center; gap: 6px;">
                      <input id="estimate-group-hidden" type="checkbox" />
                      非表示
                    </label>
                  </div>
                  <div class="item-form-row">
                    <label for="estimate-group-pricing-notes">メモ</label>
                    <input id="estimate-group-pricing-notes" type="text" placeholder="内部用メモ" />
                  </div>
                </div>

                <div class="section" id="estimate-group-summary">
                  <h4>グループ概要（summary）</h4>
                  <div class="item-form-row">
                    <label>数量/単位</label>
                    <input id="estimate-summary-quantity" type="number" step="0.01" min="0" style="max-width: 100px;" />
                    <input id="estimate-summary-unit" type="text" placeholder="式" style="max-width: 80px;" />
                  </div>
                  <div class="item-form-row">
                    <label>単価/金額</label>
                    <input id="estimate-summary-unitprice" type="number" step="1" min="0" style="max-width: 120px;" />
                    <input id="estimate-summary-amount" type="number" step="1" min="0" style="max-width: 120px;" />
                  </div>
                </div>

                <div class="section" id="estimate-group-lines">
                  <h4>内訳明細（detailed）</h4>
                  <div class="estimate-lines-header">
                    <span>内容</span>
                    <span>数量</span>
                    <span>単位</span>
                    <span>単価</span>
                    <span>金額</span>
                    <span>備考</span>
                    <span></span>
                  </div>
                  <div id="estimate-lineitems-list"></div>
                  <div class="item-form-row" style="margin-top: 4px;">
                    <button id="btn-estimate-line-add" type="button">内訳行を追加</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <h3>JSON編集</h3>
              <textarea id="estimate-json" rows="12" spellcheck="false" placeholder="{ ... 見積書JSON ... }"></textarea>
              <div style="margin-top: 4px;">
                <button id="btn-estimate-apply-json" type="button">JSONを反映</button>
                <button id="btn-estimate-export-xlsx" type="button">見積書xlsxを出力</button>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /right -->
    </main>

    <script src="./renderer.js"></script>
  </body>
</html>
